{"componentChunkName":"component---src-templates-blog-post-js","path":"/creating-a-form-validation-hook-with-tdd/","result":{"data":{"markdownRemark":{"html":"<h2>Introduction</h2>\n<p>Hi guys! My name is Carlos, I'm from Brazil and I'm a front-end web developer. This is my first article in life and I'm very excited about that. I hope you can learn something from it and I would really appreciate if you could leave your feedback.</p>\n<h2>Inspiration</h2>\n<p>Developing forms is a very common task in web development and almost every developer has to do this from time to time. I was working on an application recently where I have got to write a lot of forms and the validation part was always too repetitive.</p>\n<p>I was always copying and pasting the exact same logic between my forms. So I started googling some React form validation libs and I've found some good ones like <a href=\"https://jaredpalmer.com/formik\">formik</a> and <a href=\"https://react-hook-form.com/\">react-hook-form</a>. They are awesome and lifesavers when it comes to working with forms.</p>\n<p>After reading some examples from their documentations and understanding how they work I felt prepared to use the <a href=\"https://reactjs.org/docs/hooks-reference.html\">hooks api</a> to build my own form validation solution and I think you should do the same if you want to challenge yourself. I mean, it's so good that we have an infinity of well-tested solutions ready to install and use on our applications and we should use them on 99% of the time because they are already adopted and tested by the community.</p>\n<p>But I think we don't necessarily need to always consume something ready, instead, we can try to create our own solutions for the same problems and learn a lot of things that will help us to become better developers. It's all about pushing ourselves to another level.</p>\n<h2>Context</h2>\n<p>React Hooks is a <del>recent</del> API that brings many of the class components features to function components like state management and lifecycle hooks. You can use hooks like <code>useState</code> to literally give your function components the power to manage state variables or <code>useEffect</code> to manage your function components lifecycle and run side effects like calling an API they mount.</p>\n<p>If you don't know the Hooks API, I strongly recommend that you read the <a href=\"https://reactjs.org/docs/hooks-intro.html\">official hooks introduction</a> so that you will be more comfortable with the code we are going to write.</p>\n<h2>Requirements</h2>\n<p>To start our Hook development, we need to set up some expectations for it.</p>\n<ol>\n<li>Accept the validation logic for each form field</li>\n<li>Support the following validation types:</li>\n</ol>\n<ul>\n<li><strong>required</strong>: check if the field is filled with any value</li>\n<li><strong>pattern</strong>: a regex that will be tested against the field value</li>\n<li><strong>custom validation</strong>: a function that will be called by our Hook with the field value, letting us execute any other validation logic</li>\n</ul>\n<ol start=\"3\">\n<li>Validate fields as the user types</li>\n<li>Exposes the form validation status</li>\n</ol>\n<p>With these requirements, we can start developing our Hook.</p>\n<h2>Set up</h2>\n<p>You can use any boilerplate you want to set up the application. I'm going to use <a href=\"https://create-react-app.dev/\">create-react-app</a>.</p>\n<p>All the tutorial code is available on this <a href=\"https://github.com/csilva2810/react-hook-validation\">repo</a>. All the code evolution is separated by small commits, so if you find yourself stuck at any time, you can look at the commits to keep moving forward.</p>\n<p>We are going to use TDD to write all the tutorial code.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\nimport { useForm } from &quot;./useForm&quot;\n\ndescribe(&quot;useForm&quot;, () =&gt; {\n  describe(&quot;smoke tests&quot;, () =&gt; {\n    it(&quot;should be a function&quot;, () =&gt; {\n      expect(typeof useForm).toBe(&quot;function&quot;)\n    })\n  })\n})</code>\n        </deckgo-highlight-code>\n<p>A Hook is a Javascript function that must have the prefix <strong>use</strong> in its name so that React can distinguish it from other functions.</p>\n<p>Let's create a file <code>useForm.js</code> that exports a function following this name convention.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nexport function useForm() {}</code>\n        </deckgo-highlight-code>\n<p>Now that we have our Hook ready we can start implementing the requirements.</p>\n<h2>1. Accept the validation logic for each form field</h2>\n<p>Our Hook needs to accept as argument an options object which we are going to use to configure it. We will also apply some validation on the <strong>validations</strong> option.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nexport function useForm({ validations }) {\n  if (!validations) {\n    throw new Error(&quot;the option `validations` is required&quot;)\n  }\n\n  if (typeof validations !== &quot;object&quot;) {\n    throw new Error(&quot;the option `validations` should be an object&quot;)\n  }\n}</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\nimport { useForm } from &quot;./useForm&quot;\n\ndescribe(&quot;useForm&quot;, () =&gt; {\n  describe(&quot;smoke tests&quot;, () =&gt; {\n    it(&quot;should be a function&quot;, () =&gt; {\n      expect(typeof useForm).toBe(&quot;function&quot;)\n    })\n\n    it(&quot;should require the `validations` option&quot;, () =&gt; {\n      expect(() =&gt; {\n        useForm({})\n      }).toThrow(&quot;the option `validations` is required&quot;)\n    })\n\n    it(&quot;should require the validation option to be an object&quot;, () =&gt; {\n      expect(() =&gt; {\n        useForm({\n          validations: true,\n        })\n      }).toThrow(&quot;the option `validations` should be an object&quot;)\n    })\n  })\n})</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/83c6dfbb44ed211ebecfbd9e4ce47b54d9f473ea\">See the commit for this code</a></small></p>\n<p>Now, we have to define how our validations option will look like, there are two possible structures that I can think of. One would be an array of validations and the other an object indexed by the name of the field. The array would be something like this:</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">const validations = [\n  {\n    field: &quot;name&quot;,\n    validations: {\n      required: {},\n      pattern: {},\n    },\n  },\n]</code>\n        </deckgo-highlight-code>\n<p>The object structure would be something like:</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">const validations = {\n  name: {\n    required: {},\n    pattern: {},\n  },\n}</code>\n        </deckgo-highlight-code>\n<p>Using the array structure whenever we need to run a specific validation we will have to find the corresponding field validation in the array.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">const rules = validations.find(validation =&gt; validation.name === fieldName)</code>\n        </deckgo-highlight-code>\n<p>With the object structure, we only need to access the corresponding index.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">const rules = validations[fieldName]</code>\n        </deckgo-highlight-code>\n<p>The object structure seems to be more simple and better in terms of performance. That's why we are going to stick with that one.</p>\n<h2>2. Supporting the validation types:</h2>\n<p>Now that we have our validation option defined we can start writing the code to support the different validation types that we want to run. Let's get started with the required validation since it's the simplest one. Any validation should return an error message for the user, this error message could be a default value or some custom one.</p>\n<h3>Required rule implementation</h3>\n<p>We will start implementing a function that runs our validations for a single field, we will call it <code>validateField</code>.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/useForm.spec.js\n...\ndescribe(&#39;validateField&#39;, () =&gt; {\n  describe(&#39;required&#39;, () =&gt; {\n    it(&quot;should return a default error message for fields that don&#39;t have a value&quot;, () =&gt; {\n      const hook = useForm({\n        validations: {\n          name: {\n            required: true,\n          },\n        },\n      });\n\n      expect(hook.validateField(&#39;name&#39;, &#39;&#39;)).toBe(&#39;required&#39;);\n    });\n  });\n});</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/47e12cda2f4fc4dd5b0ec2d3a2b64ca217aab813\">See the commit for this code</a></small></p>\n<p>We are testing that our Hook has to return a validation function that we are going to use to validate our form fields. This function will receive the field name and value as arguments, run our validations and return an error message if it fails.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\n...\nfunction validateField(name, value) {\n  // get the validation rules for the field\n  const rules = validations[name];\n\n  // check if the rules exist since a field can not have validations\n  if (rules) {\n    // if the required rule is registered\n    if (rules.required) {\n      // now we validate the value checking if it has a value\n      // we are using trim, to strip whitespaces before and after the value\n      if (!value.trim()) {\n        return &#39;required&#39;;\n      }\n    }\n  }\n\n  // if there are no erros, we return an empty string\n  return &#39;&#39;;\n}\n\nreturn {\n  validateField,\n};</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/687a4022a8c46fc3cfd3f80d802b5a56d5270508\">See the commit for this code</a></small></p>\n<p>Now that the required rule is working, let's do a slight improvement to it. We are returning a \"required\" message from the validation if it fails, but we also could be able to pass a custom error message like \"the field 'name' is required\" or we could write the error message using his own language. In my case, that would be \"o campo 'nome' é obrigatório\" (Portuguese). So let's do it.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\nit(&quot;should return a custom error message&quot;, () =&gt; {\n  const hook = useForm({\n    validations: {\n      name: {\n        required: &#39;the field &quot;name&quot; is required&#39;,\n      },\n    },\n  })\n\n  expect(hook.validateField(&quot;name&quot;, &quot;&quot;)).toBe(&#39;the field &quot;name&quot; is required&#39;)\n})</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\n...\nif (rules.required) {\n  // now we validate the value checking if it has a value\n  // we are using trim, to strip whitespaces before and after the value\n  if (!value.trim()) {\n    return typeof rules.required === &#39;string&#39; ? rules.required : &#39;required&#39;;\n  }\n}\n...</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/03e31e85cc2f32dfc5df8c2edf471fda0a1c8e41\">See the commit for this code</a></small></p>\n<p>Now we are checking if the value of the required rule is a string and if it's true we assume that some custom message was passed and then we return that, otherwise we return the default message. And we have our first rule working! 🎉\nNow that we have the structure well defined the next validations are going to be much easier to implement.</p>\n<h3>Pattern rule implementation</h3>\n<p>We are ready to start implementing the pattern rule. This rule will be a little bit different because we will have to execute a regex using the field value.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\n...\ndescribe(&#39;pattern&#39;, () =&gt; {\n  it(&#39;should return an error message if the value does not satisfy the pattern&#39;, () =&gt; {\n    const hook = useForm({\n      validations: {\n        email: {\n          pattern: {\n            value: /\\w+@\\w+\\.com/gi,\n          },\n        },\n      },\n    });\n\n    expect(hook.validateField(&#39;email&#39;, &#39;&#39;)).toBe(&#39;invalid&#39;);\n  });\n\n  it(&#39;should return an custom error message if the message attribute exists&#39;, () =&gt; {\n    const hook = useForm({\n      validations: {\n        email: {\n          pattern: {\n            value: /\\w+@\\w+\\.com/gi,\n            message: &#39;Invalid e-mail&#39;,\n          },\n        },\n      },\n    });\n\n    expect(hook.validateField(&#39;email&#39;, &#39;&#39;)).toBe(&#39;Invalid e-mail&#39;);\n  });\n});\n...</code>\n        </deckgo-highlight-code>\n<p>For the pattern validation, we will receive an object containing two attributes:</p>\n<ol>\n<li>value - A regex with the pattern we want to enforce.</li>\n<li>message - A string with a custom error message. Let's implement the logic now.</li>\n</ol>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\n...\n// if the pattern rule is registered\nif (rules.pattern) {\n  // we execute the regex\n  if (!new RegExp(rules.pattern.value).exec(value)) {\n    // if the value does not match with the regex pattern, we try to return\n    // the custom message and fallback to the default message in case\n    return rules.pattern.message || &#39;invalid&#39;;\n  }\n}\n...</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/d7d9ac8a77bbf1675487747fe42235607642e2f2\">See the commit for this code</a></small></p>\n<p>That one was a lot easier, right?</p>\n<h3>The validation rule</h3>\n<p>Now we can start implementing our validate rule. This one is a little bit different because we want to give the developer the power to run any logic inside de validation. That means that he or she could even run business logic inside this validation. This one sounds complicated to implement, but it's not!</p>\n<p>In order to give the developer such flexibility, our validation rule will expect a function, this function will be called by our Hook with the field value, so the developer can do anything he wants with the value and then return an error message or an empty string. Let's go to the code.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\n...\n    describe(&#39;validate&#39;, () =&gt; {\n      let validateMock;\n      let hook;\n\n      beforeEach(() =&gt; {\n        validateMock = jest.fn((value) =&gt; {\n          if (Number(value) &lt; 18) {\n            return &#39;You are not able to get drive permission&#39;;\n          }\n\n          return &#39;&#39;;\n        });\n\n        hook = useForm({\n          validations: {\n            age: {\n              validate: validateMock,\n            },\n          },\n        });\n      });\n\n      it(&#39;should execute the validate function passing the field value&#39;, () =&gt; {\n        hook.validateField(&#39;age&#39;, &#39;10&#39;);\n\n        expect(validateMock).toHaveBeenCalledWith(&#39;10&#39;);\n      });\n\n      it(&#39;should be executed and return a string&#39;, () =&gt; {\n        hook.validateField(&#39;age&#39;, &#39;10&#39;);\n\n        expect(validateMock).toHaveBeenCalled();\n        expect(typeof validateMock.mock.results[0].value).toBe(&#39;string&#39;);\n      });\n\n      it(&#39;should return an error message&#39;, () =&gt; {\n        hook.validateField(&#39;age&#39;, &#39;10&#39;);\n\n        expect(validateMock.mock.results[0].value).toBe(&#39;You are not able to get a drive permission&#39;);\n      });\n\n      it(&#39;should return an empty string when value is valid&#39;, () =&gt; {\n        hook.validateField(&#39;age&#39;, &#39;20&#39;);\n\n        expect(validateMock.mock.results[0].value).toBe(&#39;&#39;);\n      });\n    });\n...</code>\n        </deckgo-highlight-code>\n<p>The tests here are a little bit more complicated, we are creating a <a href=\"https://jestjs.io/docs/en/mock-function-api\">Jest mock function</a> mocking its implementation and using some methods to test if our function was called with the appropriate value and if it returns the values that we expect. Now we can implement the logic to fulfill the test expectations.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\n...\n// if it has a validation function and its type is a function\nif (rules.validate &amp;&amp; typeof rules.validate === &#39;function&#39;) {\n  // we run the validate function with the field value\n  const error = rules.validate(value);\n\n  // if an error message was returned, we return it\n  if (error) {\n    return error;\n  }\n}\n...</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/8d99afa6a849388dcd744487a623f05a6744e5e4\">See the commit for this code</a></small></p>\n<p>The implementation is way more simple! Now we can move over the next step of our Hook.</p>\n<h2>3. Validate fields as the user types.</h2>\n<p>We already have all the validation rules implemented and now we have to give life to our Hook connecting it to form inputs and validating them as the user types. To do so, we have to provide an API for the components to be able to bind the form inputs with our Hook.</p>\n<p>We are going to create a simple form with a single field to test this feature.</p>\n<p>First, we are going to install and configure the <a href=\"https://testing-library.com/docs/react-testing-library/intro\">React Testing Library</a> to test the components.</p>\n<deckgo-highlight-code language=\"shell\" theme=\"nord\"  >\n          <code slot=\"code\">yarn add --dev @testing-library/jest-dom @testing-library/react jest-environment-jsdom-sixteen</code>\n        </deckgo-highlight-code>\n<p>Update the test script inside your <code>package.json</code></p>\n<deckgo-highlight-code language=\"diff\" theme=\"nord\"  >\n          <code slot=\"code\">...\n-   &quot;test&quot;: &quot;react-scripts test --env=dom&quot;\n+   &quot;test&quot;: &quot;react-scripts test --env=jest-environment-jsdom-sixteen&quot;\n...</code>\n        </deckgo-highlight-code>\n<p>Now we are able to start writing our tests.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.spec.jsx\nimport React from &quot;react&quot;\nimport { render } from &quot;@testing-library/react&quot;\nimport &quot;@testing-library/jest-dom/extend-expect&quot;\n\nimport SimpleForm from &quot;./SimpleForm&quot;\n\ndescribe(&quot;&lt;SimpleForm /&gt;&quot;, () =&gt; {\n  it(&quot;should render a name input&quot;, () =&gt; {\n    const { getByLabelText } = render(&lt;SimpleForm /&gt;)\n\n    const nameInput = getByLabelText(&quot;name&quot;)\n\n    expect(nameInput).toBeInTheDocument()\n  })\n})</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.jsx\nimport React, { useState } from &quot;react&quot;\n\nconst SimpleForm = () =&gt; {\n  const [name, setName] = useState(&quot;&quot;)\n\n  const handleSubmit = e =&gt; e.preventDefault()\n\n  return (\n    &lt;form onSubmit={handleSubmit}&gt;\n      &lt;div&gt;\n        &lt;label htmlFor=&quot;name&quot;&gt;name&lt;/label&gt;\n        &lt;input\n          type=&quot;text&quot;\n          name=&quot;name&quot;\n          id=&quot;name&quot;\n          value={name}\n          onChange={e =&gt; setName(e.target.value)}\n        /&gt;\n      &lt;/div&gt;\n    &lt;/form&gt;\n  )\n}\n\nexport default SimpleForm</code>\n        </deckgo-highlight-code>\n<p>Now, we have to use it.</p>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">// src/App.js\nimport React from &quot;react&quot;\nimport &quot;./styles.css&quot;\n\nimport SimpleForm from &quot;./components/SimpleForm&quot;\n\nconst App = () =&gt; &lt;SimpleForm /&gt;\n\nexport default App</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/ae5879776d746f8bea3717cba6ae2ce1def28264\">See the commit for this code</a></small></p>\n<p>Ok, now that we have the form component we can start using our hook to validate fields. First, we are going to do this in a programmatic way and then we can start thinking about how we can improve.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.spec.jsx\n...\nimport { render, fireEvent } from &#39;@testing-library/react&#39;;\n\n...\n\ndescribe(&#39;&lt;SimpleForm /&gt;&#39;, () =&gt; {\n  ...\n  it(&#39;should render an error message&#39;, async () =&gt; {\n    const { getByLabelText, findByText } = render(&lt;SimpleForm /&gt;);\n\n    const nameInput = getByLabelText(&#39;name&#39;);\n\n    // fires a change event in the input with value &#39;ab&#39;\n    fireEvent.change(nameInput, {\n      target: { value: &#39;ab&#39; }\n    });\n\n    // expects the input to have the value &#39;ab&#39;\n    expect(nameInput).toHaveValue(&#39;ab&#39;);\n\n    // looks up on the DOM an element with the &#39;invalid name&#39; text\n    const error = await findByText(&#39;invalid name&#39;);\n\n    // expects the element to exits\n    expect(error).toBeInTheDocument();  });\n});</code>\n        </deckgo-highlight-code>\n<p>We are expecting that after we input the value 'ab' on the input element, an element with the text 'invalid name' will exist on the DOM.</p>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.tsx\n...\n\nimport { useForm } from &#39;../useForm&#39;;\n\nconst SimpleForm = () =&gt; {\n  ...\n\n  // create a state variable for the name validation errors\n  const [nameError, setNameError] = useState(&#39;&#39;);\n  const { validateField } = useForm({\n    validations: {\n      name: {\n        pattern: {\n          value: /^\\w{3,50}$/,\n          message: &#39;invalid name&#39;\n        }\n      }\n    }\n  });\n\n  // handle change events in the name input\n  const handleNameChange = e =&gt; {\n    const { value } = e.target;\n\n    // set the name state with the field value\n    setName(value);\n    // validates the name field and sets the error state\n    setNameError(validateField(&#39;name&#39;, value));\n  };\n\n  return (\n    &lt;form onSubmit={handleSubmit}&gt;\n      &lt;div&gt;\n        &lt;label htmlFor=&quot;name&quot;&gt;name&lt;/label&gt;\n        &lt;input\n          ...\n          onChange={handleNameChange}\n        /&gt;\n        {nameError &amp;&amp; &lt;p&gt;{nameError}&lt;/p&gt;}\n      &lt;/div&gt;\n    &lt;/form&gt;\n  );\n};\n\nexport default SimpleForm;</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/57f53e2f370dd69fae08fc8d818211d34ad24cdc\">See the commit for this code</a></small></p>\n<p>Now our input is being validated and responding to the validation errors. But as you can see, we have to do so much in order to display the error messages for the users. Let's break it in parts:</p>\n<ol>\n<li>Create the state for the field value.</li>\n<li>Create the state for the field error message.</li>\n<li>Create a function to handle the input changes.</li>\n<li>Update the field state value.</li>\n<li>Validate the field.</li>\n<li>Update the error state with the validation result.</li>\n</ol>\n<p>Imagine a very common scenario where we have ten different fields to validate. We would have to repeat this process for all of them. I wouldn't be happy if I had to do that. I think we can improve our Hook abstracting this process.</p>\n<h4>Improving the validation logic.</h4>\n<p>As we have to create a state for every field value and error. We could use the <code>setState</code> in our Hook to keep an object with the form values and another one with the form errors. We also have to create a function and bind it to the <code>onChange</code> event of our inputs. Our hook could exports a function that binds the input <code>value</code> with our values object and the <code>onChange</code> with a function that validates the field value and updates the values and the errors objects.</p>\n<p>Let's start by creating our values and errors object as states of our Hook.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nimport { useState } from &#39;react&#39;;\n\nexport function useForm({ validations }) {\n  ...\n\n  const [values, setValues] = useState({});\n  const [errors, setErrors] = useState({});\n\n  ...\n\n  return {\n    values,\n    errors,\n    validateField,\n  };\n}</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/dfbc3f65722969379d00ef18901f7705c88182c1\">See the commit for this code</a></small></p>\n<p>At this point, our hook tests will be breaking, that's because we started using <code>useState</code> inside it. One rule of Hooks is that they can only be used inside React components, but that is not what's happening inside our tests. Hopefully, there's is a simple solution to this problem. Let's fix it right now.</p>\n<p>First, we have to install the <a href=\"https://github.com/testing-library/react-hooks-testing-library\">react-hooks-testing-library</a>.</p>\n<deckgo-highlight-code language=\"shell\" theme=\"nord\"  >\n          <code slot=\"code\">yarn add --dev @testing-library/react-hooks react-test-renderer</code>\n        </deckgo-highlight-code>\n<p>This library will help us to initialize our hook inside our tests simulating a component environment. We will have to use its <code>renderHook</code> function to do that. All we have to do is wrap our hook initialization inside this function and use its result.</p>\n<deckgo-highlight-code language=\"diff\" theme=\"nord\"  >\n          <code slot=\"code\"># src/useForm.spec.js\n+import { renderHook } from &#39;@testing-library/react-hooks&#39;;\n\n...\n\n# inside describe(&#39;smoke tests&#39;)\n-      expect(() =&gt; {\n-        useForm({});\n-      }).toThrow(&#39;the option `validations` is required&#39;);\n+      renderHook(() =&gt; {\n+        expect(() =&gt; {\n+          useForm({});\n+        }).toThrow(&#39;the option `validations` is required&#39;);\n+      });\n\n...\n\n# inside describe(&#39;validateField&#39;)\n-        const hook = useForm({\n+        const { result } = renderHook(() =&gt; useForm({\n           ...\n-        });\n+        }));\n\n-        expect(hook.validateField(&#39;name&#39;, &#39;&#39;)).toBe(&#39;required&#39;);\n+        expect(result.current.validateField(&#39;name&#39;, &#39;&#39;)).toBe(&#39;required&#39;);\n\n...\n\n# inside beforeEach\n-        hook = useForm({\n+        const { result } = renderHook(() =&gt; useForm({\n           ...\n-        });\n+        }));\n+\n+        hook = result.current;</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/e478834c435adb7a32d53a1b37a34d93f43b20de\">See the commit for this code</a></small></p>\n<p>Now we can create the function that we are going to use to bind our inputs to our Hook.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/useForm.spec.js\n\n...\n\ndescribe(&#39;bindField&#39;, () =&gt; {\n  it(&#39;should validate the name parameter&#39;, () =&gt; {\n    const { result } = renderHook(() =&gt; useForm({\n      validations: {\n        name: {\n          required: true,\n        }\n      }\n    }));\n\n    expect(() =&gt; {\n      result.current.bindField();\n    }).toThrow(&#39;The field name parameter is required&#39;);\n\n    expect(() =&gt; {\n      result.current.bindField(1);\n    }).toThrow(&#39;The field name should be a string&#39;);\n  });\n\n  it(&#39;should return an object with value and onChange attributes&#39;, () =&gt; {\n    const { result } = renderHook(() =&gt; useForm({\n      validations: {\n        name: {\n          required: true,\n        }\n      }\n    }));\n\n    expect(result.current.bindField(&#39;name&#39;)).toEqual({\n      value: expect.any(String),\n      onChange: expect.any(Function),\n    });\n  });\n});</code>\n        </deckgo-highlight-code>\n<p>As our test is expecting, we must implement a <code>bindField</code> function that should return an object with a value attribute that must be a string and an onChange function. We are expecting that the <code>bindField</code> function to throw some errors for the name parameter when it is invalid.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nimport { useState } from &#39;react&#39;;\n\nexport function useForm({ validations }) {\n  ...\n\n  function bindField() {\n    if (!name) {\n      throw new Error(&#39;The field name parameter is required&#39;);\n    }\n\n    if (name &amp;&amp; typeof name !== &#39;string&#39;) {\n      throw new Error(&#39;The field name should be a string&#39;);\n    }\n\n    return {\n      value: &#39;&#39;,\n      onChange: () =&gt; { },\n    }\n  }\n\n  return {\n    values,\n    errors,\n    validateField,\n    bindField,\n  };\n}</code>\n        </deckgo-highlight-code>\n<p>As this function will be responsible for bind the inputs to our Hook, we should be able to tell which field we are going to bind. The function could receive the name of the field as a parameter. We also can start using this variable to pass a value to our field and to update our Hook state on the onChange function.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/useForm.spec.js\nimport { renderHook, act } from &#39;@testing-library/react-hooks&#39;;\n\n...\n\ndescribe(&#39;bindField&#39;, () =&gt; {\n  ...\n\n  describe(&#39;onChange&#39;, () =&gt; {\n    it(&#39;should update the Hook state when called&#39;, () =&gt; {\n      const { result } = renderHook(() =&gt; useForm({\n        validations: {\n          name: {\n            required: true,\n          },\n        },\n      }));\n\n      const bindFieldResult = result.current.bindField(&#39;name&#39;);\n\n      act(() =&gt; {\n        bindFieldResult.onChange({ target: { value: &#39;John&#39; } });\n      });\n\n      expect(result.current.values.name).toBe(&#39;John&#39;);\n      expect(result.current.errors.name).toBe(&#39;&#39;);\n\n      act(() =&gt; {\n        bindFieldResult.onChange({ target: { value: &#39;&#39; } });\n      });\n\n      expect(result.current.values.name).toBe(&#39;&#39;);\n      expect(result.current.errors.name).toBe(&#39;required&#39;);\n    });\n  });\n});</code>\n        </deckgo-highlight-code>\n<p>In this test, we are using the <a href=\"https://reactjs.org/docs/test-utils.html#act\">act</a> function. It's important to wrap all state updates inside this function for the React to be able to perform the updates appropriately. We are testing the behavior of calling the <code>onChange</code> function, simulating the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/change_event\">Event</a> object that will be passed to our function when our users type on the inputs.</p>\n<p>Now we can start the implementation of the <code>onChange</code> function to attend to the test expectation.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nimport { useState } from &#39;react&#39;;\n\nexport function useForm({ validations }) {\n  ...\n\n  function bindField() {\n    ...\n\n    return {\n      value: values[name] || &#39;&#39;,\n      onChange: (e) =&gt; {\n        const { value } = e.target;\n\n        setValues(state =&gt; ({\n          ...state,\n          [name]: value,\n        }));\n\n        setErrors(state =&gt; ({\n          ...state,\n          [name]: validateField(name, value),\n        }));\n      },\n    }\n  }\n\n  ...\n}</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/ce5f281ddc87ed11cb88c748b1632a9902e1c076\">See the commit for this code</a></small></p>\n<p>On the <code>onChange</code> function we are doing the same thing we did when we implemented the programmatic validation. The only difference is that know our state is an object, so we have to update the corresponding field. The only thing left to do now is changing our <code>SimpleForm</code> component to use our <code>bindField</code> function.</p>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.tsx\n...\n\nconst SimpleForm = () =&gt; {\n  const handleSubmit = e =&gt; {\n    e.preventDefault();\n\n    console.log(&#39;values&#39;, values);\n  };\n\n  const { values, errors, bindField } = useForm({\n    validations: {\n      name: {\n        pattern: {\n          value: /^\\w{3,50}$/,\n          message: &#39;invalid name&#39;\n        }\n      }\n    }\n  });\n\n  return (\n    &lt;form onSubmit={handleSubmit}&gt;\n      &lt;div&gt;\n        &lt;label htmlFor=&quot;name&quot;&gt;name&lt;/label&gt;\n        &lt;input type=&quot;text&quot; name=&quot;name&quot; id=&quot;name&quot; {...bindField(&#39;name&#39;)} /&gt;\n        {errors.name &amp;&amp; &lt;p&gt;{errors.name}&lt;/p&gt;}\n      &lt;/div&gt;\n    &lt;/form&gt;\n  );\n};\n\nexport default SimpleForm;</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/2cf9a2134ee7ada86e09c481b05d5b155f3fc351\">See the commit for this code</a></small></p>\n<p>It's worth mentioning our <code>bindField</code> call. Since it returns an object with the value and the onChange attributes, we are spreading it as props to the input element. It works as a shortcut to this:</p>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">const nameBind = bindField(&#39;name&#39;);\n\nreturn &lt;input ... value={nameBind.value} onChange={nameBind.onChange} /&gt;</code>\n        </deckgo-highlight-code>\n<p>Now it's a lot more simple to add more fields to our form, we only have to use the <code>bindField</code> function and optionally add validations for it. Let's add one more field to test.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\n...\ndescribe(&#39;&lt;SimpleForm /&gt;&#39;, () =&gt; {\n  ...\n  it(&#39;should render an erro message for the birthDate field&#39;, async () =&gt; {\n    const { getByLabelText, findByText } = render(&lt;SimpleForm /&gt;);\n    const input = getByLabelText(&#39;birth date&#39;);\n\n    fireEvent.change(input, {\n      target: { value: &#39;11&#39; }\n    });\n\n    expect(input).toHaveValue(&#39;11&#39;);\n\n    const error = await findByText(&#39;invalid date format (dd/mm/yyyy)&#39;);\n\n    expect(error).toBeInTheDocument();\n  });\n});</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.tsx\n...\nconst SimpleForm = () =&gt; {\n  ...\n\n  const { values, errors, bindField } = useForm({\n    validations: {\n      ...\n      birthDate: {\n        pattern: {\n          value: /^\\d{2}\\/\\d{2}\\/\\d{4}$/,\n          message: &#39;invalid date format (dd/mm/yyyy)&#39;\n        }\n      }\n    }\n  });\n\n  return (\n    &lt;form onSubmit={handleSubmit}&gt;\n      ...\n\n      &lt;div&gt;\n        &lt;label htmlFor=&quot;birthDate&quot;&gt;birth date&lt;/label&gt;\n        &lt;input\n          type=&quot;text&quot;\n          name=&quot;birthDate&quot;\n          id=&quot;birthDate&quot;\n          {...bindField(&#39;birthDate&#39;)}\n        /&gt;\n        {errors.birthDate &amp;&amp; &lt;p&gt;{errors.birthDate}&lt;/p&gt;}\n      &lt;/div&gt;\n    &lt;/form&gt;\n  );\n};\n\nexport default SimpleForm;</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/b5f8242a434af12a8db33ba7c626ce3d5afee592\">See the commit for this code</a></small></p>\n<p>That worked perfectly 🎉! One last thing I think would be nice to have in this step, is our hook to accept an object with the initial value for each, field. This would be handy in situations like editing existing information and also if we want to prefill an input with some default value. Fortunately, this is going to be easy to implement, we have to accept this object as an option on our Hook and set it to our values state in its initialization.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/useForm.spec.js\n...\n\ndescribe(&#39;initialValues&#39;, () =&gt; {\n  it(&#39;should trhow an Error if the initialValues is not an object&#39;, () =&gt; {\n    renderHook(() =&gt; {\n      expect(() =&gt; {\n        useForm({\n          initialValues: true,\n        })\n      }).toThrow(&#39;the option `initialValues` should be an object&#39;);\n    });\n  });\n\n  it(&#39;should initialize the values state with the initial values&#39;, () =&gt; {\n    const { result } = renderHook(() =&gt; useForm({\n      initialValues: {\n        name: &#39;Carlos&#39;,\n      },\n      validations: {},\n    }));\n\n    expect(result.current.values.name).toBe(&#39;Carlos&#39;);\n  });\n});</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nexport function useForm({ validations, initialValues = {} }) {\n  ...\n\n  if (typeof initialValues !== &#39;object&#39;) {\n    throw new Error(&#39;the option `initialValues` should be an object&#39;);\n  }\n\n  const [values, setValues] = useState(initialValues);\n\n  ...\n}</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/eceead4e063b9f024d4161f359ad1387de2aafbd\">See the commit for this code</a></small></p>\n<p>This option was very simple to implement and it makes our hook more flexible and interesting to use. Now we are ready to move over to the final implementation details of our Hook.</p>\n<h2>4. Exposing the form status</h2>\n<p>We are almost done! The last thing we have to do is expose the form status from the Hook. It's important because we need to know if the entire form is valid before we send it to the backend or do whatever we need to do with the form values.</p>\n<p>We are going to implement a function called <code>isValid</code> and export it from our Hook so we can use this function on our components to do something with the form. In this case, we are going to disable the submit button if the form is invalid.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/useForm.spec.js\n...\n\ndescribe(&#39;isValid&#39;, () =&gt; {\n  it(&#39;should be a function&#39;, () =&gt; {\n    const { result } = renderHook(() =&gt; useForm({\n      validations: {},\n    }));\n\n    expect(typeof result.current.isValid).toBe(&#39;function&#39;);\n  });\n});</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/608d55e340bc00d2190732b31c3c0da671f18dde\">See the commit for this code</a></small></p>\n<p>As we can see, the test is expecting the <code>isValid</code> to be a function.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nexport function useForm({ validations, initialValues = {} }) {\n  ...\n\n  function isValid() {\n    return false;\n  }\n\n  return {\n    ...\n    isValid,\n  };\n}</code>\n        </deckgo-highlight-code>\n<p>Now that we have our initial setup we can start implementing the function as it should be.</p>\n<p>We already have the validation working individually so the best way to check if the entire form is valid is by iterating over our validations object and testing all the fields. The first time we find an error, we can stop the iteration and return <code>false</code>. We could use the <code>errors</code> object to see if there are any errors on it, but running the validations for each field assures that we are getting the last validation result. Let's write the test first.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// src/useForm.spec.js\n...\n\ndescribe(&#39;isValid&#39;, () =&gt; {\n  ...\n\n  it(&#39;should return false when it finds any error on the form&#39;, () =&gt; {\n    const { result } = renderHook(() =&gt; useForm({\n      initialValues: {\n        name: &#39;Carlos&#39;,\n        surname: &#39;&#39;,\n      },\n      validations: {\n        name: {\n          required: true,\n        },\n        surname: {\n          required: true,\n        },\n        birthDate: {\n          pattern: {\n            value: /^\\d{2}\\/\\d{2}\\/\\d{4}$/gi,\n            message: &#39;invalid date&#39;,\n          },\n        },\n      },\n    }));\n\n    expect(result.current.isValid()).toBe(false);\n  });\n\n  it(&#39;should return true if all the form fields are valid&#39;, () =&gt; {\n    const { result } = renderHook(() =&gt; useForm({\n      initialValues: {\n        name: &#39;Carlos&#39;,\n        surname: &#39;Silva&#39;,\n        birthDate: &#39;28/10/1990&#39;,\n      },\n      validations: {\n        name: {\n          required: true,\n        },\n        surname: {\n          required: true,\n        },\n        birthDate: {\n          pattern: {\n            value: /^\\d{2}\\/\\d{2}\\/\\d{4}$/gi,\n            message: &#39;invalid date&#39;,\n          },\n        },\n      },\n    }));\n\n    expect(result.current.isValid()).toBe(true);\n  });\n});</code>\n        </deckgo-highlight-code>\n<p>We are testing a form with some invalid fields and expecting the <code>isValid</code> function to return false and another one with all fields valid and expecting it to return true. Let's implement this logic.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.js\nexport function useForm({ validations, initialValues = {} }) {\n  ...\n\n  function isValid() {\n    const hasErrors = Object.keys(validations).some(name =&gt;\n      Boolean(validateField(name, values[name]))\n    );\n\n    return !hasErrors;\n  }\n\n  ...\n}</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/53ddf0b308d59105d30d28dd17c192cf0b6edb10\">See the commit for this code</a></small></p>\n<p>Let's understand this function.</p>\n<p>First, we are using the <code>Object.keys</code> function to transform all keys in our object in an array. For example:</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">const validations = {\n  name: { ... },\n  surname: { ... },\n  birthDate: { ... },\n};\n\nObject.keys(validations); // [&#39;name&#39;, &#39;surname&#39;, &#39;birthDate&#39;]</code>\n        </deckgo-highlight-code>\n<p>Then, we are calling the Array <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/some\">some</a> function on this array to test if some of the fields are invalid. A cool fact about this function is that it stops the iteration if it finds what we are looking for. For example:</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">const array = [1, 2, 3, 4, 5]\n\narray.some(test =&gt; {\n  console.log(test) // 1, 2\n  return test === 2 // stops the iteration here and return true\n})</code>\n        </deckgo-highlight-code>\n<p>If the function doesn't find what we are looking for, it will return <code>false</code>. In our case, we are looking for a field with errors.</p>\n<p>Our <code>validateField</code> function returns a not empty string if it finds an error or an empty string otherwise. We are using the <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean\">Boolean</a> function to convert the string to a boolean. An empty string is converted to <code>false</code>. If the <code>validateField</code> returns a not empty string it will be converted to <code>true</code> causing the <code>some</code> execution to stop and return true to our <code>hasErrors</code> variable.</p>\n<p>Finally, we negate the <code>hasErrors</code> variable, which means that if we have any errors, the <code>isValid</code> result will be <code>false</code>, which means that our form is not valid. Otherwise the result will be <code>true</code>.</p>\n<p>With this function working as we expected, we can try to use it on our SimpleForm. We are going to create a submit button and keep it disabled until all the form fields are valid.</p>\n<deckgo-highlight-code language=\"javascript\" theme=\"nord\"  >\n          <code slot=\"code\">// useForm.spec.js\n...\ndescribe(&#39;&lt;SimpleForm /&gt;&#39;, () =&gt; {\n  ...\n  it(&#39;should keep the submit button disabled until all the inputs are valid&#39;, () =&gt; {\n    const { getByLabelText, getByRole } = render(&lt;SimpleForm /&gt;);\n    const name = getByLabelText(&#39;name&#39;);\n    const birthDate = getByLabelText(&#39;birth date&#39;);\n    const submit = getByRole(&#39;button&#39;);\n\n    expect(submit).toBeDisabled();\n\n    fireEvent.change(name, {\n      target: { value: &#39;Carlos&#39; }\n    });\n\n    expect(submit).toBeDisabled();\n\n    fireEvent.change(birthDate, {\n      target: { value: &#39;30/12&#39; }\n    });\n\n    expect(submit).toBeDisabled();\n\n    fireEvent.change(birthDate, {\n      target: { value: &#39;30/12/2020&#39; }\n    });\n\n    expect(submit).not.toBeDisabled();\n  });\n});</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"jsx\" theme=\"nord\"  >\n          <code slot=\"code\">// src/components/SimpleForm.tsx\n...\nconst SimpleForm = () =&gt; {\n  ...\n\n  const { values, errors, bindField, isValid } = useForm({\n    ...\n  });\n\n  return (\n    &lt;form onSubmit={handleSubmit}&gt;\n      ...\n\n      &lt;button type=&quot;submit&quot; disabled={!isValid()}&gt;\n        submit\n      &lt;/button&gt;\n    &lt;/form&gt;\n  );\n};\n\n...</code>\n        </deckgo-highlight-code>\n<p><small style=\"display: block; text-align: center;\"><a href=\"https://github.com/csilva2810/react-hook-validation/commit/4b5c8a39f5b9f032e396ffbdc26bc826936f8783\">See the commit for this code</a></small></p>\n<p>In our SimpleForm, we get the <code>isValid</code> function and use its result value to control the disabled attribute of our button. Simple right?</p>\n<p>With this, we've got all the requirements implemented and a fully functional Hook to validate our forms. We could add more validations like a <code>minLength</code>, <code>maxLength</code> for example and we could add some more functionalities like the ability to change a value programmatically exposing a function from the hook to update the state. But I think you are more than capable to do that by yourself! So I will let you with the challenge of making these improvements.</p>\n<p>All the source code of this tutorial is available on my <a href=\"https://github.com/csilva2810\">Github</a> at this <a href=\"https://github.com/csilva2810/react-hook-validation\">repository</a>.\nThe <a href=\"https://github.com/csilva2810/react-hook-validation/commits/master\">commits</a> are following the tutorial steps, so you can follow the commits to see how it was changing over time.\nFeel free to fork it and play with the code!</p>\n<p>Thanks a lot for reading this! Let me know what you think! I'd really appreciate hearing your thoughts!</p>\n<p><img src=\"https://media.giphy.com/media/lTpme2Po0hkqI/giphy.gif\" alt=\"That&#x27;s all folks\"></p>","frontmatter":{"title":"Creating a form validation hook for React apps","thumbnail":"https://source.unsplash.com/Rs5BQj5zbf8"}}},"pageContext":{"slug":"/creating-a-form-validation-hook-with-tdd/"}},"staticQueryHashes":["63159454"]}